<% provide :title do %>Proceso participativo<% end %>
<% content_for :header_addon do %>
<% end %>

<% if params[:order].present? %>
  <% if params[:order] == 'new' %>
    <% @quizzes = Quiz.where(quiz_type: 1).order(created_at: :desc) %>
  <% else %>
    <% @quizzes = Quiz.where(quiz_type: 1) %>
    <% # TODO: Orden por mas apoyadas %>
  <% end %>
<% else %>
  <% @quizzes = Quiz.where(quiz_type: 1) %>
<% end%>
<main class="proceso-main">
  <div class="center-element mobile-view">
    <%= render "shared/search_form",
              search_path: proposals_path(page: 1),
              i18n_namespace: "proposals.index.search_form" %>
  </div>
  <div class="jumbo light">
    <div class="row">
      <div class="small-12 column">
        <%= image_tag "help/help_icon_polls.png", alt: t("poll.icon_alt"), class: "align-sub" %>
        <h1 class="inline-block">Diagnósticos de acción por tema</h1>
      </div>
    </div>
    <div class="row">
      <div class="small-12 medium-9 column end">
        <p>Esto es una descripción sobre el proceso participativo.</p>
      </div>
    </div>
    <div class="row">
      <%= render 'shared/back_to' %>
    </div>
  </div>
  <div class="row">
    <div id="proposals" class="proposals-list small-12 medium-12 column">
      <h2 class="sidebar-title">Capítulos</h2>
      <ul id="categories" class="no-bullet categories">
        <% Tag.category.each_with_index do |category, index| %>
          <%= link_to new_quiz_path(chapter: category.id, type: 1) do %>
          <li class="inline-block chapter-small">
            <i class="fas fa-hand-paper" style="color: #<%= SecureRandom.random_number(10**6).to_s.rjust(6, '0') %>;"></i>
            <%= category.name %>
          </li>
          <% end %>
        <% end %>
      </ul>
      <br/>
      <ul class="no-bullet submenu">
        <% @orders = [['Más apoyadas', 'support'], ['Nuevas', 'new']] %>
        <% @orders.each do |name, order| %>
          <li class="inline-block">
            <%= link_to current_path_with_query_params(order: order), class: order == params[:order] ? "is-active" : "" do %>
              <%= content_tag(order == @current_order ? :h2 : :span) do %>
                <% name %>
              <% end %>
            <% end %>
          </li>
        <% end %>
      </ul>
      <div id="proposals-list">
        <% if @quizzes.any? %>
          <% @quizzes.each do |quiz| %>
            <div class="proposal clear">
              <div class="panel">
                <div class="row">
                  <div class="small-12 medium-3 column">
                    <h4><%= quiz.name || '(Sin título)' %></h4>
                    <strong>Capítulo</strong>
                    <% if quiz.tag %>
                      <p><i class="fas fa-hand-paper" style="color: #004a83;"></i> <%= quiz.tag %></p>
                    <% else %>
                      <p>Sin capítulo</p>
                    <% end %>
                    <strong>Fecha</strong><br/>
                    <%= quiz.created_at.to_date %>
                  </div>
                  <div class="small-12 medium-6 column supports-container">
                    <h4>Descripción</h4>
                    <p><%= quiz.description || 'Sin descripción.' %></p>
                  </div>
                  <div class="small-12 medium-3 column supports-container">
                    <div class="supports text-center">
                      <span class="total-supports">
                        <%= Vote.where(votable_type: "Quiz", votable_id: quiz.id).count %>
                        <% if Vote.where(votable_type: "Quiz", votable_id: quiz.id).count == 1 %>
                          apoyo
                        <% else %>
                          apoyos
                        <% end %>
                      </span>
                      <div class="in-favor">
                        <% if current_user %>
                          <%= link_to Vote.where(votable_type: "Quiz", votable_id: quiz.id, voter_id: current_user.id).exists? ? nil : vote_quizzes_path(quiz_id: quiz.id),
                              class: "button button-support small expanded",
                              title: 'Apoyar',
                              method: "post",
                              disabled: Vote.where(votable_type: "Quiz", votable_id: quiz.id, voter_id: current_user.id).exists?,
                              remote: true do %>
                            <% if Vote.where(votable_type: "Quiz", votable_id: quiz.id, voter_id: current_user.id).exists? %>
                              Ya apoyaste
                            <% else %>
                              Apoyar
                            <% end %>
                          <% end %>
                        <% else %>
                          <button disabled class="button button-support small expanded">Ingresa para votar</button>
                        <% end %>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          <% end %>
        <% end %>
      </div>
      </div>
  </div>
</main>
