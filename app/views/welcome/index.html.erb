<% content_for :body_class, "home-page" %>

<% content_for :canonical do %>
  <%= render "shared/canonical", href: root_url %>
<% end %>

<%= render Shared::BannerComponent.new("homepage") %>

<% provide :social_media_meta_tags do %>
  <%= render "shared/social_media_meta_tags",
              social_url: root_url %>
<% end %>

<%= render "shared/header", header: @header %>

<%= render 'choose_type' %>
<div class="jumbo highlight proceso-main">
    <h3 class="text-center">¿Cómo te gustaría participar?</h3>
    <div class="row flexbox">
      <div class="proceso-card">
        <div class="card-section">
          <%= image_tag('participacion-individual.jpg') %>
        </div>
        <div class="card-section text-center">
          <h4>Participar individualmente</h4>
          <small>¡Queremos escuchar tu opinión sobre los derechos humanos!</small>
          <%= link_to 'Participar', current_user ? '/confirm_participation' : new_user_session_path, class: 'button expanded' %>
        </div>
      </div>
    <% if current_user %>
      <% if Group.where(user_id: current_user.id).exists? %>
        <div class="proceso-card">
          <div class="card-section">
            <%= image_tag('participacion-grupal.jpg') %>
          </div>
          <div class="card-section text-center">
            <h4>Participar grupalmente</h4>
            <small>¿Qué opina tu grupo sobre los derechos humanos?</small>
            <% if Group.where(user_id: current_user.id).select{|g| g if g.users.count > 1}.count > 0 %>
              <%= select_tag 'groups', options_from_collection_for_select(Group.where(user_id: current_user.id).select{|g| g if g.users.count > 1}, 'id', 'name'), prompt: 'Elige un grupo' %>
              <small>Solo aparecerán grupos con dos participantes o más</small><br/><br/>
              <%= link_to 'Participar', '#', class: 'button expanded', id: 'groups_submit', disabled: true %>
            <% else %>
              <small>No tienes ningún grupo con dos o más participantes.</small><br/><br/>
              <%= link_to 'Participar', '#', class: 'button expanded', id: 'groups_submit', disabled: true %>
            <% end %>
          </div>
        </div>
      <% else %>
        <%= link_to 'groups/new' do %>
              <div class="proceso-card disabled">
                <div class="card-section">
                  <%= image_tag('participacion-grupal.jpg') %>
                </div>
                <div class="card-section text-center">
                  <h4>Participar grupalmente</h4>
                  <small>No tienes un grupo creado, haz clic para crear uno.</small>
                </div>
              </div>
          <% end %>
      <% end %>
    <% else %>
      <div class="proceso-card">
        <div class="card-section">
          <%= image_tag('participacion-grupal.jpg') %>
        </div>
        <div class="card-section text-center">
          <h4>Participar grupalmente</h4>
          <small>¿Qué opina tu grupo sobre los derechos humanos?</small>
          <%= link_to 'Participar', new_user_session_path, class: 'button expanded' %>
        </div>
      </div>
    <% end %>
  </div>
  <br/>
</div>

<main>
  <% @quizzes_type = [
    [1, 'Diagnósticos de acción'],
    [3, 'Sugerencias de acciones'],
    [2, 'Sugerencias de monitoreo']] %>


<div class="row">
    <section id="feed" class="widget-feed">
        <div class="small-12 medium-12 column">
          <% if Quiz.where(visible: true).where.not(name: 'TMP').exists? %>
            <div class="feed-content">
            <h3 class="title">Conoce y apoya otras propuestas</h3>
              <% Quiz.where(visible: true).where.not(name: 'TMP').sort_by {|quiz| quiz.votes}.reverse[0, 3].each_with_index do |quiz, idx| %>
                <div class="row">
                  <div class="column">
                    <small>#<%= idx + 1 %></small>
                  </div>
                  <div class="small-12 medium-4 column">
                    <div class="proposal">
                      <h5>Problemas de DD.HH.</h5>
                      <p style="white-space: nowrap; overflow: hidden; text-overflow: ellipsis;"><%= eval(quiz.q1)['q3'] or 'Sin respuesta' %></p>
                    </div>
                  </div>
                  <div class="small-12 medium-4 column">
                    <div class="proposal">
                      <h5>Ideas de solución</h5>
                      <p style="white-space: nowrap; overflow: hidden; text-overflow: ellipsis;"><%= eval(quiz.q2)['q8'] or 'Sin respuesta' %></p>
                    </div>
                  </div>
                  <div class="small-12 medium-4 column">
                    <div class="proposal">
                      <h5>Monitoreo</h5>
                      <p style="white-space: nowrap; overflow: hidden; text-overflow: ellipsis;"><%= eval(quiz.q3)['q9'] or 'Sin respuesta' %></p>
                    </div>
                  </div>
                </div>
                <hr style="margin: 0;"/>
              <% end %>
            </div>
            <br/>
            <i class="fas fa-list-ul"></i> <strong><%= link_to 'Ver todas', proposals_path(:order => 'new') %></strong>
          <% end %>
        </div>
    </section>
  </div>
</div>

  <div class="row">
    <% if @cards.any? %>
      <div class="small-12 column <%= "large-8" if feed_processes_enabled? %>">
        <h2 class="title"><%= t("welcome.cards.title") %></h2>

        <%= render "shared/cards", cards: @cards %>
      </div>
    <% end %>

    <% if feed_processes_enabled? %>
      <div class="small-12 large-4 column">
        <%= render "processes" %>
      </div>
    <% end %>
  </div>

  <% if feature?("user.recommendations") && (@recommended_debates.present? || @recommended_proposals.present?) %>
    <%= render "recommended",
                recommended_debates: @recommended_debates,
                recommended_proposals: @recommended_proposals %>
  <% end %>
</main>

<script>
$(document).ready(function() {
  $('#groups_submit').removeAttr('href')

  $('#groups').on('change', function() {
    if (this.value.length > 0) {
      $('#groups_submit').attr('href', '/confirm_participation?group=' + this.value)
      $('#groups_submit').removeAttr('disabled')
    } else {
      $('#groups_submit').attr('disabled', 'disabled')
      $('#groups_submit').removeAttr('href')
    }
  })
})
</script>